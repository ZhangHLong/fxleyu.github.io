---
layout   : post
title    : "初探 Java 内存模型"
subtitle : "读书笔记"
date     : 2018-09-28 23:17:03
author   : fxleyu
tags:
    - Java
    - JMM
---
Java 虚拟机规范中试图定义一种 Java 内存模型（Java Memory Model， JMM）来屏蔽各种硬件
和操作系统的内存访问差异，以实现让 Java 程序在各种平台下都能达到一致的内存访问效果。[2]

在给定程序和该程序的执行踪迹（execution trace）的情况下，内存模型描述执行踪迹是否是程序
的合法执行。Java 内存模型的工作原理是检查执行踪迹中的每个读操作，并根据某些规则检查该读
操作所观察到的写操作是否有效。   
内存模型描述了程序的可能行为。只要程序的所有结果执行产生可由内存模型预测的结果，JMM 的
实现就可以自由地生成它喜欢的任何代码。   
这为实现者提供了大量的自由来执行无数的代码转换，包括重新排序动作和删除不必要的同步。[1]

# Java 并发编程实战之 Java 内存模型
本章将尽可能地避开 Java 内存模型（JMM）的底层实现，而将重点放在一些高层设计问题，例如安
全发布，同步策略的规定以及一致性等。

## 1 什么是内存模型，为什么需要它
Java 语言规范要求 JVM 在线程中维护一种类似串行的语义：只要程序的最终结果与在严格串行环境
中执行的结果相同，那么指令重排、缓存等优化操作都是允许的。  
编译器通过对指令重新排序来实现优化执行，以及使用成熟的全局寄存器分配算法。   
只有当多个线程要共享数据时，才必须协调它们之间的操作，并且 JVM 依赖程序通过同步操作来
找出这些协调操作将在何时发生。    
JMM 规定了 JVM 必须遵循一组最小保证，这组保证规定了对变量的写入操作在何时将对其他线程
可见。

### 1.1 平台的内存模型
在共享内存的多处理器体系架构中，每个处理器都拥有自己的缓存，并且定期地与主内存进行协调。
在不同的处理器架构中提供不同级别的缓存一致性（Cache Coherence），其中一部分只提供最小
保证，即允许不同的处理器在任意时刻从同一存储为止看到不同的值。操作系统、编译器以及运行时
（有时甚至包括应用程序）需要弥合这种硬件能力和线程安全需求之间的差异。

在架构定义的内存模型中将告诉应用程序可以从内存系统中获取怎样的保证，此外还定义了一些特殊
指定（称为内存栅栏或栅栏），当需要共享数据时，这些指令就能实现额外的存储协调保证。

Java 还提供了自己的内存模型，并且 JVM 通过在适当的位置上插入内存栅栏来屏蔽在 JMM 在底层
平台内存模型之间的差异。

### 1.2 重排序
JMM 使得不同线程看到的操作执行顺序是不同的，从而导致在缺乏同步的情况下，要推断操作的执行
顺序将变得更加复杂。各种使操作延迟或者看似乱序执行的不同原因，都可以归为重排序。

内存级的重排序会使的程序变得不可预测。同步将限制编译器、运行时和硬件对内存操作重排序的
方式，从而在实施重排序时不会破坏 JMM 提供的可见性保证。

在大多数主流的处理器架构中，内存模型都非常强大，使得读取 `volatile` 变量的性能与读取非
`volatile` 变量的性能大致相当。

### 1.3 Java 内存模型简介

### 1.4 借助同步

## 2 发布
### 2.1 不安全发布

### 2.2 安全的发布

### 2.3 安全初始化模式

### 2.4 双重检查加锁

## 3 初始化过程中的安全性

## 小结
Java 内存模型说明了某个线程的内存操作在哪些情况下对于其他线程是可见的。其中包括确保这些
操作是按照一种 Happens-Before 的偏序关系进行排序，而这种关系是基于内存操作和同步操作等
级别来定义的。

# 主内存与工作内存

# 内存间交互操作

# 对 volatile 型变量的特殊规则

# 对 long 和 double 型变量的特殊规则

# 原子性、可见性与有序性

# 先行发生原则

# 参考
- [1] [Java Language Specification (17.4. Memory Model)](https://docs.oracle.com/javase/specs/jls/se8/html/jls-17.html#jls-17.4)
- [2] [深入理解Java虚拟机（第2版）(第 12 章 Java 内存模型与线程)](https://book.douban.com/subject/24722612/)
- [3] [Java并发编程实战 (第 16 章 Java 内存模型)](https://book.douban.com/subject/10484692/)
